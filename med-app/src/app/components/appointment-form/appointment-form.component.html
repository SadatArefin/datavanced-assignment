<div class="form-container">
  <h2>{{ isEdit ? "Edit" : "Create" }} Appointment</h2>

  <form [formGroup]="f" (ngSubmit)="save()">
    <div class="form-row">
      <mat-form-field appearance="outline">
        <mat-label>Patient</mat-label>
        <mat-select formControlName="patientId" required>
          @for (p of patients; track p) {
            <mat-option [value]="p.id">{{
              p.name
            }}</mat-option>
          }
        </mat-select>
        @if (f.get('patientId')?.hasError('required')) {
          <mat-error
            >Patient is required</mat-error
            >
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Doctor</mat-label>
          <mat-select formControlName="doctorId" required>
            @for (d of doctors; track d) {
              <mat-option [value]="d.id">{{
                d.name
              }}</mat-option>
            }
          </mat-select>
          @if (f.get('doctorId')?.hasError('required')) {
            <mat-error
              >Doctor is required</mat-error
              >
            }
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Appointment Date</mat-label>
            <input
              matInput
              type="date"
              formControlName="appointmentDate"
              required
              />
              @if (f.get('appointmentDate')?.hasError('required')) {
                <mat-error
                  >Date is required</mat-error
                  >
              }
            </mat-form-field>

            <div class="visit-type-container">
              <label>Visit Type</label>
              <mat-button-toggle-group formControlName="visitType" name="visitType">
                <mat-button-toggle [value]="VisitType.First"
                  >First Visit</mat-button-toggle
                  >
                  <mat-button-toggle [value]="VisitType.FollowUp"
                    >Follow-up</mat-button-toggle
                    >
                  </mat-button-toggle-group>
                </div>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Notes</mat-label>
                  <textarea
                    matInput
                    placeholder="Additional notes"
                    formControlName="notes"
                    rows="3"
                  ></textarea>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Diagnosis</mat-label>
                  <textarea
                    matInput
                    placeholder="Diagnosis details"
                    formControlName="diagnosis"
                    rows="3"
                  ></textarea>
                </mat-form-field>
              </div>

              <div class="prescriptions-section">
                <div class="section-header">
                  <h3>Prescriptions</h3>
                  <button
                    mat-stroked-button
                    type="button"
                    color="primary"
                    (click)="addRow()"
                    >
                    <mat-icon>add</mat-icon>
                    Add Prescription
                  </button>
                </div>

                @if (details.length > 0) {
                  <div class="prescriptions-table">
                    <table
                      mat-table
                      [dataSource]="details.controls"
                      class="prescriptions-table"
                      >
                      <ng-container matColumnDef="medicine">
                        <th mat-header-cell *matHeaderCellDef>Medicine</th>
                        <td mat-cell *matCellDef="let control; let i = index">
                          <div [formGroup]="control">
                            <mat-form-field appearance="outline">
                              <mat-select formControlName="medicineId" required>
                                @for (m of medicines; track m) {
                                  <mat-option [value]="m.id">{{
                                    m.name
                                  }}</mat-option>
                                }
                              </mat-select>
                            </mat-form-field>
                          </div>
                        </td>
                      </ng-container>
                      <ng-container matColumnDef="dosage">
                        <th mat-header-cell *matHeaderCellDef>Dosage</th>
                        <td mat-cell *matCellDef="let control; let i = index">
                          <div [formGroup]="control">
                            <mat-form-field appearance="outline">
                              <input
                                matInput
                                placeholder="e.g., 1 tablet twice daily"
                                formControlName="dosage"
                                required
                                />
                              </mat-form-field>
                            </div>
                          </td>
                        </ng-container>
                        <ng-container matColumnDef="startDate">
                          <th mat-header-cell *matHeaderCellDef>Start Date</th>
                          <td mat-cell *matCellDef="let control; let i = index">
                            <div [formGroup]="control">
                              <mat-form-field appearance="outline">
                                <input
                                  matInput
                                  type="date"
                                  formControlName="startDate"
                                  required
                                  />
                                </mat-form-field>
                              </div>
                            </td>
                          </ng-container>
                          <ng-container matColumnDef="endDate">
                            <th mat-header-cell *matHeaderCellDef>End Date</th>
                            <td mat-cell *matCellDef="let control; let i = index">
                              <div [formGroup]="control">
                                <mat-form-field appearance="outline">
                                  <input
                                    matInput
                                    type="date"
                                    formControlName="endDate"
                                    required
                                    />
                                  </mat-form-field>
                                </div>
                              </td>
                            </ng-container>
                            <ng-container matColumnDef="notes">
                              <th mat-header-cell *matHeaderCellDef>Notes</th>
                              <td mat-cell *matCellDef="let control; let i = index">
                                <div [formGroup]="control">
                                  <mat-form-field appearance="outline">
                                    <input
                                      matInput
                                      placeholder="Additional notes"
                                      formControlName="notes"
                                      />
                                    </mat-form-field>
                                  </div>
                                </td>
                              </ng-container>
                              <ng-container matColumnDef="actions">
                                <th mat-header-cell *matHeaderCellDef>Actions</th>
                                <td mat-cell *matCellDef="let control; let i = index">
                                  <button
                                    mat-icon-button
                                    type="button"
                                    color="warn"
                                    (click)="removeRow(i)"
                                    >
                                    <mat-icon>delete</mat-icon>
                                  </button>
                                </td>
                              </ng-container>
                              <tr mat-header-row *matHeaderRowDef="prescriptionCols"></tr>
                              <tr mat-row *matRowDef="let row; columns: prescriptionCols"></tr>
                            </table>
                          </div>
                        }
                      </div>

                      <div class="form-actions">
                        <button
                          mat-raised-button
                          color="primary"
                          type="submit"
                          [disabled]="!f.valid"
                          >
                          {{ isEdit ? "Update" : "Create" }} Appointment
                        </button>
                        <button mat-button type="button" (click)="cancel()">Cancel</button>
                      </div>
                    </form>
                  </div>
